<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Acceso BUPC</title>
  <link rel="icon" type="image/png" href="LOGOweb.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    /* --- DISEÑO PROFESIONAL BUPC V2 --- */
    :root {
        --ucol-azul: #003366;
        --ucol-verde: #006747;
        --ucol-naranja: #ff8c00;
    }

/* --- EL NUEVO BODY CON MARCA DE AGUA --- */
    body { 
        font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif; 
        height: 100vh; /* Altura completa */
        margin: 0;
        display: flex; 
        align-items: center; 
        justify-content: center;
        position: relative; /* Necesario para el truco de la imagen */
        overflow: hidden; /* Evita barras de desplazamiento si el logo es muy grande */
        background-color: #f0f2f5; /* Color base por si la imagen no carga */
    }

    /* LA CAPA FANTASMA (El Logo de fondo) */
    body::before {
        content: "";
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        /* AQUÍ VA TU IMAGEN - Revisa que el nombre sea exacto */
        background-image: url('BUPCfondo.png'); 
        background-position: center center;
        background-repeat: no-repeat;
        /* 'contain' muestra el logo entero. 'cover' llena toda la pantalla pero puede cortar bordes */
        background-size: contain; 
        
        /* --- CONTROL DE TRANSPARENCIA --- */
        /* 0.0 = invisible | 1.0 = totalmente visible */
        /* Juega con este número: 0.1 es muy sutil, 0.2 se nota más */
        opacity: 0.0; 
        
        z-index: -1; /* Esto asegura que se quede DETRÁS de la tarjeta blanca */
        
        /* OPCIONAL: Si quieres que el logo se vea en escala de grises (más elegante) descomenta esto: */
        /* filter: grayscale(100%); */
    }
    
    .tarjeta-acceso {
      background: #ffffff;
      width: 90%; /* Un poco más ancha en móviles */
      max-width: 420px;
      padding: 40px 30px; /* Más espacio interno */
      border-radius: 24px; /* Bordes más redondeados */
      /* Sombra más suave y moderna */
      box-shadow: 0 20px 60px rgba(0, 51, 102, 0.1), 0 10px 20px rgba(0,0,0,0.05);
      text-align: center; 
      position: relative; 
      overflow: hidden;
      border-top: none; /* Quitamos el borde verde superior para un look más limpio */
    }
/* --- ESTILO PANTALLA 1: LOGIN (Marca de Agua Grande) --- */
    #pantalla-login {
        position: relative; /* Necesario para contener al fantasma */
        z-index: 1;
    }
    
    #pantalla-login::after {
        content: "";
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        
        background-image: url('LOGOweb.png');
        background-position: center center;
        background-size: 60%; /* Logo grande y centrado */
        background-repeat: no-repeat;
        
        opacity: 0.08; /* Muy sutil (casi transparente) */
        z-index: -1;   /* Se queda detrás del texto */
        pointer-events: none; 
    }
    /* Barra superior de color institucional */
    .tarjeta-acceso::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0;
        height: 12px; background: linear-gradient(90deg, var(--ucol-azul) 60%, var(--ucol-verde) 100%);
    }

    h1 { color: var(--ucol-azul); font-weight: 900; font-size: 2rem; margin: 15px 0 5px 0; letter-spacing: -0.5px; }
    p.subtitulo { color: #667788; font-size: 1.1rem; font-weight: 500; margin-bottom: 30px; }
    
    .estado-badge {
      background: #eef2f7; color: var(--ucol-azul); 
      padding: 8px 16px; border-radius: 50px; font-size: 0.85rem; 
      font-weight: 700; letter-spacing: 1px; text-transform: uppercase; display: inline-block;
    }

    .icono-central { font-size: 5rem; color: var(--ucol-naranja); filter: drop-shadow(0 10px 15px rgba(255,140,0,0.3)); }

    .btn-bupc {
      background: var(--ucol-azul); color: white; border: none; 
      padding: 20px; font-size: 1.3rem; font-weight: 800; 
      border-radius: 16px; width: 100%; letter-spacing: 0.5px;
      box-shadow: 0 10px 25px rgba(0, 51, 102, 0.3);
      transition: all 0.3s ease; cursor: pointer;
    }
    .btn-bupc:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(0, 51, 102, 0.4); background: #004080; }
    .btn-bupc:active { transform: scale(0.98); background-color: #002244; }

    /* Animaciones */
    #pantalla-exito, #pantalla-carga { 
        display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(255,255,255,0.98); /* Fondo casi blanco puro */
        z-index: 10; flex-direction: column; align-items: center; justify-content: center; 
        border-radius: 24px; 
        animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

  <div class="tarjeta-acceso">
    <div id="pantalla-login" style="display: none;">
      <h1 class="mb-4">IDENTIFÍCATE</h1>
      <p class="subtitulo">Ingresa tu ID Institucional</p>
      
      <div class="mb-4">
        <input type="text" id="input-id-login" class="form-control text-center" 
               placeholder="ejemplo@BUPC.ucol" 
               style="font-size: 1.2rem; padding: 15px; border: 2px solid #003366; border-radius: 12px;">
      </div>

      <button id="btn-busqueda" onclick="verificarUsuarioOnline()" class="btn-bupc">
        BUSCAR MI CUENTA
      </button>
    </div>
    <div id="pantalla-inicio" style="display: none;">
      <div class="mb-2">
        <p style="font-size: 0.85rem; font-weight: bold; color: #555; margin: 0; line-height: 1.2; text-transform: uppercase; letter-spacing: 1px;">
            Brigada Universitaria de <br> Protección Civil
        </p>
      </div>

      <div class="d-flex align-items-center justify-content-center mb-4" style="gap: 15px;">
        <img src="LOGOweb.png" alt="Logo BUPC" style="width: 65px; height: auto;">
        
        <div class="estado-badge" style="font-size: 0.75rem; padding: 5px 12px; margin: 0;">
            SISTEMA DE ASISTENCIA
        </div>
      </div>
      <h1 id="nombre-usuario">...</h1>
      <div class="mt-3 text-center">
        <button onclick="cerrarSesion()" style="background: none; border: none; color: #274e13; text-decoration: underline; cursor: pointer;">
          ¿No eres tú? Cambiar cuenta
        </button>
      </div>
      <div class="my-4">
        <div class="mb-3">
            <i class="bi bi-fingerprint" style="font-size: 4rem; color: #ff8c00;"></i>
        </div>

      <div class="my-4">
        <label style="font-weight: bold; color: #003366; margin-bottom: 5px;">CLAVE DE ACCESO</label>
        <input type="text" id="input-pin" class="form-control text-center" 
               placeholder="****" maxlength="4" inputmode="numeric"
               style="font-size: 2rem; letter-spacing: 8px; border: 2px solid #ff8c00; color: #003366; font-weight: bold;">
      </div>

      <button id="btn-registro" onclick="registrarAsistencia()" class="btn-bupc">
        CONFIRMAR REGISTRO
      </button>
      
      <div class="mt-3 text-muted" style="font-size: 0.8rem;">
        ID de Sesión: <span id="id-debug">...</span>
      </div>
    </div>

    <div id="pantalla-carga">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
      <h4 class="mt-3">Conectando...</h4>
    </div>

    <div id="pantalla-exito">
      <i class="bi bi-check-circle-fill" style="font-size: 5rem; color: #28a745;"></i>
      <h2 class="text-success mt-3">¡LISTO!</h2>
      <p id="mensaje-servidor" class="px-4">Registro guardado</p>
      <button onclick="location.reload()" class="btn btn-outline-secondary mt-3">Cerrar</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script>
    // --- CONFIGURACIÓN ---
    // ¡PEGA TU URL DE APPS SCRIPT AQUÍ ABAJO!
    const API_URL = "https://script.google.com/macros/s/AKfycbw4d50w3KdCuW8kNspRE1337AQX6AykB5pm-wALWV-axte38QCLVx0TBTJB6-arfZpc5w/exec";
    const PIN_DEL_DIA = "2026"; // <--- ¡AQUÍ CAMBIAS LA CLAVE CADA MAÑANA!
    
    // --- LÓGICA ---
    const params = new URLSearchParams(window.location.search);
    // Buscamos el usuario en la URL o en la memoria del teléfono
    let userId = params.get('u') || localStorage.getItem('bupc_user_id');

    // Inicialización
// --- LÓGICA DE NAVEGACIÓN ---
    window.onload = function() {
      // 1. ¿Ya tenemos usuario? (Por URL o Memoria)
      if (userId) {
        // SI YA HAY USUARIO -> Mostramos la pantalla del PIN (La de siempre)
        localStorage.setItem('bupc_user_id', userId);
        mostrarPantalla('pantalla-inicio');
        
        let nombre = userId.split('@')[0].replace(/\./g, ' ').toUpperCase();
        document.getElementById('nombre-usuario').innerText = nombre;
        document.getElementById('id-debug').innerText = userId;
      } else {
        // SI NO HAY USUARIO -> Mostramos la pantalla de Login
        mostrarPantalla('pantalla-login');
      }
    };

    // Función auxiliar para cambiar de pantallas fácil
    function mostrarPantalla(idPantalla) {
      document.getElementById('pantalla-login').style.display = 'none';
      document.getElementById('pantalla-inicio').style.display = 'none';
      document.getElementById(idPantalla).style.display = 'block';
    }

// --- FUNCIÓN BLINDADA: REGISTRO ---
    function registrarAsistencia() {
      if (!userId) return alert("Error: No hay usuario identificado");

      // 1. Validar PIN
      const pinEscrito = document.getElementById('input-pin').value;
      if (pinEscrito !== PIN_DEL_DIA) {
        alert("⛔ CLAVE INCORRECTA\nSolicita la clave del día.");
        document.getElementById('input-pin').value = "";
        return;
      }

      // 2. BLOQUEO TOTAL (Anti-Dedo Rápido)
      const btn = document.getElementById('btn-registro');
      btn.disabled = true; // Desactivamos el clic
      btn.innerText = "REGISTRANDO..."; // Feedback visual
      btn.style.opacity = "0.7"; // Se ve un poco transparente

      document.getElementById('pantalla-carga').style.display = 'flex';

      // 3. Enviar
      const urlFinal = `${API_URL}?action=checkin&u=${userId}`;

      fetch(urlFinal)
        .then(response => response.json())
        .then(data => {
          document.getElementById('pantalla-carga').style.display = 'none';
          
          if(data.status === "success") {
            document.getElementById('pantalla-exito').style.display = 'flex';
            document.getElementById('mensaje-servidor').innerText = data.mensaje;
            confetti({ particleCount: 150, spread: 70 });
            // NO reactivamos el botón aquí porque ya terminó el proceso con éxito
          } else {
            alert("Error: " + data.mensaje);
            // Si hubo error, SÍ reactivamos el botón para que intente de nuevo
            reactivarBoton(btn, "CONFIRMAR REGISTRO");
          }
        })
        .catch(error => {
          document.getElementById('pantalla-carga').style.display = 'none';
          alert("Error de conexión. Intenta de nuevo.");
          reactivarBoton(btn, "CONFIRMAR REGISTRO");
        });
    }

    // --- FUNCIÓN BLINDADA: BÚSQUEDA ---
    function verificarUsuarioOnline() {
      const idIngresado = document.getElementById('input-id-login').value.trim();
      if (!idIngresado) return alert("Escribe tu ID por favor.");

      // BLOQUEO TOTAL
      const btn = document.getElementById('btn-busqueda');
      btn.disabled = true;
      btn.innerText = "BUSCANDO...";
      btn.style.opacity = "0.7";

      document.getElementById('pantalla-carga').style.display = 'flex';

      fetch(`${API_URL}?action=validate&u=${idIngresado}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === "success") {
            window.location.href = `?u=${idIngresado}`;
          } else {
            document.getElementById('pantalla-carga').style.display = 'none';
            alert("❌ " + data.mensaje);
            reactivarBoton(btn, "BUSCAR MI CUENTA");
          }
        })
        .catch(error => {
          document.getElementById('pantalla-carga').style.display = 'none';
          alert("Error de conexión.");
          reactivarBoton(btn, "BUSCAR MI CUENTA");
        });
    }

    // Pequeña ayuda para reactivar botones si algo falla
    function reactivarBoton(boton, textoOriginal) {
        boton.disabled = false;
        boton.innerText = textoOriginal;
        boton.style.opacity = "1";
    }
    // --- FUNCIÓN DE SALIDA MAESTRA ---
    function cerrarSesion() {
      // 1. Borrar la memoria del navegador
      localStorage.removeItem('bupc_user_id');
      
      // 2. IMPORTANTE: Limpiar la URL para que no te vuelva a meter
      // Esto le quita la parte de "?u=..." y deja solo la dirección base
      window.location.href = window.location.href.split('?')[0];
    }
  </script>
</body>

</html>



















